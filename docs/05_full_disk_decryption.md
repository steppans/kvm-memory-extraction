# 5. Атака №3 - расшифровка полного диска VM offline

## Содержание

5. [Атака №3 - расшифровка полного диска VM offline](#атака-3--расшифровка-полного-диска-vm-offline)
   - [Расшифрование с помощью сформированного master key](#расшифрование-с-помощью-сформированного-master-key)
     - [Вариант 1 (неудачный)](#вариант-1-неудачный)
     - [Вариант 2 (успешный)](#вариант-2-успешный)
   - [Вывод](#вывод)


На данном этапе у атакующего уже есть:

- зашифрованный QCOW2‑образ виртуальной машины;
- извлечённый из дампа оперативной памяти **мастер‑ключ LUKS**;
- возможность работать с образом диска без запуска VM.

Цель атаки - доказать, что диск VM может быть расшифрован, без знания passphrase и без запуска гостевой ОС.

Для начала обратимся к разделу "[Анализ зашифрованного раздела](../docs/02_security_demonstation.md#анализ-зашифрованного-раздела)":

Используется режим шифрования **XTS-AES-256**, который требует:

- 256 бит - основной ключ шифрования данных;
- 256 бит - tweak‑ключ.

Итого: **512 бит (64 байта)** мастер‑ключа.

Далее подключаем образ диска как блочное устройство ядра с помощью NBD:

```bash
sudo modprobe nbd max_part=8
sudo qemu-nbd --connect=/dev/nbd0 ~/images/ubuntu/encrypted/ubuntu-encrypted.qcow2
```

В системе появляется устройство `/dev/nbd0`, содержащее раздел `/dev/nbd0p3` с LUKS‑контейнером.

## Расшифрование с помощью сформированного master key

Инструмент `bulk_extractor` извлёк из дампа памяти **два AES‑256 ключа** (см. "[Просмотр найденных AES-ключей](../docs/04_luks_masterkey_attack.md#просмотр-найденных-aes-ключей)"). Однако порядок этих ключей в памяти не гарантирован, поэтому возможны разные варианты их конкатенации.


### Вариант 1 (неудачный)

Формируем мастер‑ключ в порядке `K1 || K2`:

```bash
echo "ed5be0b121f79c48f128c67c52460d904c68d709133bf7f83503b6d53bdbf43f1ae34bc4e6f7eca1c4865bb45c2302651e74ee2918ebf83181e4d7d96e6b43f4" | xxd -r -p > luks2_master_key.bin
```

Пробуем открыть контейнер напрямую, минуя keyslot:

```bash
sudo cryptsetup open --type luks --master-key-file keys/luks2_master_key.bin /dev/nbd0p3 decrypted_luks --readonly
```

Результат:

```plaintext
Volume key does not match the volume.
```

Это означает, что длина ключа корректная, но порядок ключей неверный.


### Вариант 2 (успешный)

Меняем порядок ключей местами `K2 || K1`:

```bash
echo "1ae34bc4e6f7eca1c4865bb45c2302651e74ee2918ebf83181e4d7d96e6b43f4ed5be0b121f79c48f128c67c52460d904c68d709133bf7f83503b6d53bdbf43f" | xxd -r -p > luks2_master_key_alt.bin
```

Открываем LUKS‑контейнер снова:

```bash
sudo cryptsetup open --type luks --master-key-file keys/luks2_master_key.bin /dev/nbd0p3 decrypted_luks --readonly
```

Успех - зашифрованный раздел открыт без ввода passphrase.

После этого зашифрованный диск становится доступен как обычное блочное устройство `/dev/mapper/decrypted_luks`, которое можно:

- подключить к LVM;
- смонтировать;
- полностью прочитать.

см. пример монтирования такого блочного устройства в разделе "[](../docs/02_security_demonstation.md#анализ-зашифрованного-раздела)"

## Вывод

Данная атака демонстрирует, что:

- LUKS‑passphrase используется только для разблокировки keyslot;
- после монтирования тома мастер‑ключ постоянно хранится в оперативной памяти;
- при компрометации гипервизора или хоста возможно:
  - извлечение мастер‑ключа;
  - полная расшифровка диска без запуска VM;
  - обход любых механизмов защиты внутри гостевой ОС.

Таким образом, шифрование диска **не защищает данные от атак на работающую систему или доверенную вычислительную базу**, а лишь обеспечивает защиту данных *в состоянии покоя* (data at rest).