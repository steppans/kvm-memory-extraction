# Основные теоретические аспекты

## Содержание

- [Основные теоретические аспекты](#основные-теоретические-аспекты)
  - [QEMU и KVM](#qemu-и-kvm)
  - [LUKS и шифрование дисков в Linux](#luks-и-шифрование-дисков-в-linux)
  - [Формат виртуальных дисков qcow2](#формат-виртуальных-дисков-qcow2)
  - [Cloud-init](#cloud-init)

## QEMU и KVM

KVM (Kernel-based Virtual Machine) - это модуль ядра Linux, предоставляющий инфраструктуру аппаратной виртуализации с использованием расширений процессоров Intel VT-x или AMD-V. KVM преобразует ядро Linux в гипервизор типа 1, позволяя запускать виртуальные машины как обычные процессы хоста, но с доступом к виртуализированному оборудованию.

QEMU (Quick Emulator) - это универсальный эмулятор и виртуализатор аппаратного обеспечения, позволяющий запускать гостевые операционные системы поверх хостовой ОС. QEMU способен работать в двух режимах:

- **эмуляция**, при которой инструкции гостевой архитектуры полностью интерпретируются программно;
- **аппаратная виртуализация**, при которой выполнение гостевого кода осуществляется напрямую на процессоре хоста.

В связке QEMU и KVM выполняют разные роли:

- KVM отвечает за выполнение гостевого кода в аппаратно ускоренном режиме и управление виртуальными CPU и памятью;
- QEMU обеспечивает эмуляцию устройств (дисков, сетевых адаптеров, контроллеров ввода-вывода) и пользовательское пространство управления виртуальной машиной.

Таким образом, при использовании KVM большинство инструкций гостевой операционной системы выполняется напрямую на процессоре хоста, а QEMU используется для обработки операций ввода-вывода и управления виртуальными устройствами.

С точки зрения модели безопасности важно отметить, что виртуальная машина полностью контролируется гипервизором. Гипервизор имеет доступ к:
- оперативной памяти гостевой ОС;
- виртуальным дискам и их содержимому;
- состоянию процессора и регистров гостевой системы.

Это означает, что механизмы защиты, реализованные внутри виртуальной машины (включая шифрование диска или разграничение прав пользователей), не защищают данные от атак со стороны гипервизора, что является ключевым допущением в рамках данной работы.


## LUKS и шифрование дисков в Linux

LUKS (Linux Unified Key Setup) - это стандарт для шифрования блочных устройств в Linux, реализуемый на уровне подсистемы `dm-crypt`. LUKS обеспечивает унифицированный формат заголовка шифрованного устройства, поддержку нескольких ключевых слотов и возможность смены пользовательских паролей без повторного шифрования всего диска.

При использовании LUKS процесс работы с зашифрованным диском включает следующие этапы:
- ввод пользовательского пароля;
- получение из пароля ключа с помощью функции формирования ключей (PBKDF);
- расшифровку master key, хранящегося в заголовке LUKS;
- использование master key для прозрачного шифрования и расшифрования данных на диске.

Важно отметить, что пользовательский пароль напрямую не используется для шифрования данных. Фактическое шифрование выполняется с использованием **master key**, который:

- имеет фиксированную длину, соответствующую выбранному алгоритму шифрования;
- хранится в зашифрованном виде в заголовке LUKS;
- загружается в оперативную память после успешного открытия зашифрованного устройства.

В современных версиях LUKS (LUKS2) для защиты пользовательских паролей применяются устойчивые к перебору функции формирования ключей, такие как `argon2id`. Для шифрования данных по умолчанию используется режим `AES-XTS`, предназначенный для шифрования блочных устройств.

С точки зрения модели безопасности LUKS обеспечивает защиту данных **в состоянии покоя** (data at rest), то есть при выключенной системе или отсутствии доступа к оперативной памяти. После открытия зашифрованного устройства master key постоянно присутствует в оперативной памяти, что делает возможным его извлечение при наличии доступа к памяти системы.

В контексте виртуализации это означает, что, несмотря на корректно настроенное шифрование диска внутри виртуальной машины, гипервизор, обладающий доступом к оперативной памяти гостевой ОС, потенциально способен получить master key и, как следствие, доступ ко всем данным зашифрованного диска.


## Формат виртуальных дисков qcow2

Для хранения образов виртуальных машин в Linux часто используется формат **qcow2** (QEMU Copy On Write version 2). Этот формат поддерживает несколько ключевых возможностей, которые делают его удобным для экспериментов и исследований:

- **Copy-on-write** - новый диск может ссылаться на базовый образ, записывая только изменения, а оригинальный образ остаётся неизменным. Это позволяет экономить место на диске и легко откатывать изменения.
- **Динамический рост** - размер qcow2 файла увеличивается по мере записи данных, но никогда не превышает заданного максимального объёма.
- **Snapshots** - можно сохранять состояния виртуальной машины в определённый момент времени и возвращаться к ним при необходимости.
- **Поддержка сжатия и шифрования** - современный формат qcow2 позволяет сжимать данные и использовать встроенное шифрование.

В связке с QEMU/QEMU-KVM формат qcow2 используется для создания виртуальных дисков с базовыми образами и отдельными изменяемыми слоями, что позволяет:

1. Сохранять оригинальные образы неизменными.
2. Быстро создавать новые виртуальные машины на основе одного образа.
3. Управлять виртуальными дисками динамически, без выделения большого объёма памяти заранее.


## Cloud-init

**Cloud-init** - это инструмент автоматической инициализации виртуальных машин и cloud-образов при первом запуске. Он широко используется в облачных и виртуальных средах для автоматической настройки пользователей, сети и прочих параметров системы.

Основные возможности cloud-init:

- **Создание и настройка пользователей** - добавление учётных записей, установка паролей, настройка sudo-привилегий, загрузка SSH-ключей.
- **Конфигурация сети** - настройка IP-адресов, хостнейма, DNS и других сетевых параметров.
- **Установка пакетов и запуск скриптов** - автоматическое обновление системы, установка необходимого ПО, запуск начальных скриптов.
- **Работа с seed-образами** - для инициализации используется отдельный ISO-файл (seed-образ), который содержит файлы `user-data` и `meta-data`.

Файлы конфигурации:

- **user-data.yaml** - описывает действия при инициализации, например, создание пользователей, установка SSH-ключей, настройка паролей.
- **meta-data.yaml** - содержит метаинформацию о виртуальной машине: идентификатор, hostname, локальные параметры сети.

Связь с виртуальными дисками:

- Cloud-init позволяет запускать одну и ту же VM на базе **qcow2** образа несколько раз с разными настройками, используя отдельный seed-образ.  
- Это обеспечивает воспроизводимость экспериментов, быстрое развёртывание и возможность автоматизации без вмешательства пользователя.
