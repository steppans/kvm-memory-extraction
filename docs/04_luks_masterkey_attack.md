# 4. Атака №2 - извлечение LUKS master key из оперативной памяти

---

## Содержание

4. [Атака №2 - извлечение LUKS master key из оперативной памяти](#атака-2--извлечение-luks-master-key-из-оперативной-памяти)
   - [bulk_extractor](#bulk_extractor)
     - [Зависимости](#зависимости)
     - [Сборка инструмента](#сборка-инструмента)
     - [Исправление ошибки сборки](#исправление-ошибки-сборки)
     - [Запуск анализа](#запуск-анализа)
     - [Просмотр найденных AES-ключей](#просмотр-найденных-aes-ключей)


В разделе "[Анализ зашифрованного раздела](../docs/02_security_demonstation.md#анализ-зашифрованного-раздела)" было показано, что корневой раздел виртуальной машины защищён с использованием LUKS и недоступен для чтения при выключенной VM.

Однако после загрузки системы и ввода passphrase зашифрованный том становится доступен ядру. Для обеспечения прозрачного шифрования и дешифрования данных LUKS хранит **master key в оперативной памяти** работающей системы.

## bulk_extractor

**bulk_extractor** - это инструмент цифровой криминалистики, предназначенный для анализа сырых бинарных данных: дампов памяти, образов дисков, файловых систем и сетевых захватов. В отличие от классических forensic-утилит, он*не требует знания структуры файловой системы и работает напрямую с байтовым потоком.

Ключевая особенность `bulk_extractor` - поиск артефактов *по сигнатурам*, а не по файловой иерархии. Это делает его особенно полезным при анализе:

- дампов оперативной памяти;
- повреждённых или частично перезаписанных образов;
- зашифрованных контейнеров (метаданные, заголовки, ключевые структуры);
- процессов виртуальных машин (QEMU/KVM).

В контексте данного исследования `bulk_extractor` рассматривается как инструмент для:

- поиска чувствительных данных в дампе памяти QEMU;
- выявления криптографических артефактов (в нашем случае AES ключей);
- автоматического сканирования больших дампов без ручного hex-анализа.

### Зависимости

Для сборки bulk_extractor из исходников требуются стандартные инструменты разработки:

```bash
sudo apt update
sudo apt install build-essential autoconf automake libtool pkg-config
```

Согласно документации разработчиков, для поддержки работы с EWF-образами необходим следующий пакет:

```bash
sudo apt install libewf-dev
```

Дополнительные зависимости:

```bash
sudo apt install libssl-dev libre2-dev
```

- `libssl-dev` - заголовочные файлы OpenSSL, необходимые для компиляции криптографических модулей
- `libre2-dev` - высокопроизводительная библиотека регулярных выражений от Google

Дальнейшие зависимости, необходимые для успешной сборки `bulk_extractor`:

```bash
sudo apt install flex bison zlib1g-dev
```

- `flex` - генератор лексических анализаторов (lexer). Используется для разборки входного потока данных на токены. В `bulk_extractor` применяется при обработке бинарных структур и сигнатур.

- `bison` - генератор синтаксических анализаторов (parser). Работает в паре с `flex` и отвечает за построение логики обработки токенов.

Эти инструменты часто используются в проектах, где требуется разбор сложных форматов данных.

- `zlib1g-dev` - библиотека для работы со сжатыми данными (gzip/deflate). `bulk_extractor` использует `zlib` для обработки сжатых сегментов данных, которые могут встречаться как в образах дисков, так и в дампах памяти.

Суффикс `-dev` означает, что пакет содержит заголовочные файлы и статические библиотеки, необходимые именно для **компиляции**, а не только для выполнения программ.

### Сборка инструмента

Исходный код bulk_extractor распространяется в виде git-репозитория и использует autotools для подготовки сборочной среды. Также используются git-submodule, поэтому клонирование выполняется с флагом `--recurse-submodules`.

Клонирование репозитория:

```bash
git clone --recurse-submodules https://github.com/simsong/bulk_extractor.git
```

Переходим в каталог проекта и подготавливаем систему сборки:

```bash
./bootstrap.sh
./configure
```

На этапе конфигурации может возникнуть проблема сборки, связанная с некорректно сгенерированным Makefile.

### Исправление ошибки сборки

В файле `src/Makefile` присутствует флаг линковщика `-Wl,--pop-state`, который добавляется дважды и при этом используется некорректно из-за неправильного определения переменной `ld`.  
Это приводит к ошибкам на этапе линковки.

Для корректной сборки необходимо вручную удалить флаг `-Wl,--pop-state` в двух местах файла `src/Makefile`.

После исправления Makefile выполняем сборку и установку:

```
make
sudo make install
```

После установки бинарный файл `bulk_extractor` становится доступен в системе и может использоваться для анализа дампов памяти, образов дисков и других бинарных артефактов, связанных с цифровой криминалистикой и исследованием безопасности.

### Запуск анализа

Запуск анализа дампа памяти QEMU:

```bash
bulk_extractor qemu_dump.<PID> -o qemu_dump_info
```

- `qemu_dump.<PID>` - дамп памяти процесса QEMU, полученный с помощью `gcore`;
- `-o qemu_dump_info` - каталог, в который будут сохранены результаты анализа (feature-файлы).

После завершения работы `bulk_extractor` в каталоге `qemu_dump_info` создаётся набор файлов, каждый из которых соответствует определённому типу извлечённых данных. Для анализа криптографических ключей используется файл `aes_keys.txt`.

### Просмотр найденных AES-ключей

```bash
cat qemu_dump_info/aes_keys.txt
```

```plaintext
# BANNER FILE NOT PROVIDED (-b option)
# BULK_EXTRACTOR-Version: 2.1.1
# Feature-Recorder: aes_keys
# Filename: qemu_dump.1260
# Feature-File-Version: 1.1
1857787048      ed 5b e0 b1 21 f7 9c 48 f1 28 c6 7c 52 46 0d 90 4c 68 d7 09 13 3b f7 f8 35 03 b6 d5 3b db f4 3f AES256
1857787288      1a e3 4b c4 e6 f7 ec a1 c4 86 5b b4 5c 23 02 65 1e 74 ee 29 18 eb f8 31 81 e4 d7 d9 6e 6b 43 f4 AES256
```

- Первый столбец - смещение (offset) в дампе памяти, где был обнаружен ключ;
- Далее следует сам ключ в шестнадцатеричном представлении;
- `AES256` указывает на тип ключа и длину (256 бит).

Полученные два AES-256 ключа соответствуют внутреннему представлению ключевого материала, используемого dm-crypt/LUKS в режиме `aes-xts`. В этом режиме **используются два 256-битных ключа одновременно**, которые вместе формируют мастер‑ключ для шифрования диска.

Таким образом, извлечённые из дампа оперативной памяти AES‑ключи **могут быть напрямую использованы для расшифрования данных зашифрованного LUKS‑раздела**, без знания passphrase пользователя.
